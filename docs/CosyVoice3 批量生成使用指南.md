# CosyVoice3 æ‰¹é‡ç”Ÿæˆä½¿ç”¨æŒ‡å—

## ğŸ¯ æ¨¡å¼é€‰æ‹©å»ºè®®

### æ¨èï¼š**instruct2 æ¨¡å¼** â­â­â­â­â­

**é€‚åˆä½ çš„åœºæ™¯ï¼Œå› ä¸ºï¼š**
1. âœ… å®Œç¾æ”¯æŒæƒ…ç»ªæ§åˆ¶ï¼ˆå¼€å¿ƒã€æ‚²ä¼¤ã€æ„¤æ€’ç­‰10ç§æƒ…ç»ªï¼‰
2. âœ… å¯ä»¥æ§åˆ¶è¯­é€Ÿï¼ˆå¿«é€Ÿè¿è¯»ã€åœé¡¿å‘¼å¸ï¼‰
3. âœ… ä¿æŒç»Ÿä¸€éŸ³è‰²ï¼ˆä½¿ç”¨"å°O"çš„å‚è€ƒéŸ³é¢‘ï¼‰
4. âœ… ç”Ÿæˆè´¨é‡é«˜ä¸”ç¨³å®š

**vs zero_shotæ¨¡å¼ï¼š**
- zero_shotï¼šçº¯éŸ³è‰²å…‹éš†ï¼Œæƒ…ç»ªæ§åˆ¶å¼±
- instruct2ï¼šéŸ³è‰²å…‹éš† + æƒ…ç»ªæ§åˆ¶ = æœ€ä½³é€‰æ‹©

---

## ğŸ“¦ å®‰è£…æ­¥éª¤

### 1. å®‰è£…ä¾èµ–
```bash
# åŸºç¡€ä¾èµ–
pip install modelscope torchaudio

# å¦‚æœé‡åˆ°ç‰ˆæœ¬å†²çª
pip install modelscope==1.11.0 torchaudio==2.1.0
```

### 2. å‡†å¤‡é¡¹ç›®ç›®å½•
```bash
mkdir digital_human_training
cd digital_human_training

# åˆ›å»ºç›®å½•ç»“æ„
mkdir -p reference_audio
mkdir -p pretrained_models

# å¤åˆ¶è„šæœ¬æ–‡ä»¶
# 1. tts_batch_generator.py (ä»artifactå¤åˆ¶)
# 2. training_complete.json (åˆå¹¶åçš„æ–‡æ¡ˆ)
```

### 3. å‡†å¤‡å‚è€ƒéŸ³é¢‘ï¼ˆå…³é”®ï¼ï¼‰

è¿™æ˜¯æœ€é‡è¦çš„ä¸€æ­¥ï¼å‚è€ƒéŸ³é¢‘å†³å®šäº†ç”ŸæˆéŸ³é¢‘çš„éŸ³è‰²ã€‚

#### æ–¹æ³•Aï¼šå½•åˆ¶"å°O"çš„éŸ³é¢‘ï¼ˆæ¨èï¼‰

```bash
# 1. æ‰“å¼€å½•éŸ³è½¯ä»¶ï¼ˆæ‰‹æœºã€ç”µè„‘éƒ½å¯ä»¥ï¼‰
# 2. å½•åˆ¶ä»¥ä¸‹å†…å®¹ï¼ˆ15-30ç§’ï¼‰ï¼š

"ä½ å¥½ï¼Œæˆ‘æ˜¯å°Oã€‚æˆ‘å¾ˆé«˜å…´èƒ½å¤Ÿå¸®åŠ©ä½ å®Œæˆä»»åŠ¡ã€‚
å¸Œæœ›ä½ ä»¥åèƒ½å¤Ÿåšå¾—æ¯”æˆ‘è¿˜å¥½å‘¦ã€‚
æ— è®ºé‡åˆ°ä»€ä¹ˆå›°éš¾ï¼Œæˆ‘éƒ½ä¼šå°½åŠ›æ”¯æŒä½ çš„ã€‚"

# 3. ä¿å­˜ä¸ºé«˜è´¨é‡WAVæ ¼å¼
# 4. æ”¾åˆ°é¡¹ç›®ç›®å½•
```

**å½•éŸ³è¦æ±‚ï¼š**
- âœ… æ¸…æ™°ï¼šæ— æ‚éŸ³ã€æ— å›å£°
- âœ… å®Œæ•´ï¼šåŒ…å«å¤šç§éŸ³ç´ 
- âœ… è‡ªç„¶ï¼šè¯­æ°”è‡ªç„¶ï¼Œä¸è¦å¤ªåšä½œ
- âœ… æ ¼å¼ï¼šWAVï¼ˆ16kHzæˆ–æ›´é«˜ï¼‰
- âœ… æ—¶é•¿ï¼š15-30ç§’æœ€ä½³

**ä¿å­˜ä½ç½®ï¼š**
```
./reference_audio/prompt.wav
```

#### æ–¹æ³•Bï¼šä»ç°æœ‰è§†é¢‘ä¸­æå–ï¼ˆå¦‚æœæœ‰"å°O"çš„è§†é¢‘ï¼‰

```python
from moviepy.editor import VideoFileClip

# ä»è§†é¢‘æå–éŸ³é¢‘
video = VideoFileClip("xiao_o_video.mp4")
audio = video.audio
audio.write_audiofile("./reference_audio/prompt.wav")
```

#### æ–¹æ³•Cï¼šä½¿ç”¨ç°æˆçš„TTSç”Ÿæˆï¼ˆä¸´æ—¶æ–¹æ¡ˆï¼‰

å¦‚æœæš‚æ—¶æ²¡æœ‰"å°O"çš„éŸ³é¢‘ï¼Œå¯ä»¥å…ˆç”¨å…¶ä»–TTSç”Ÿæˆä¸€æ®µï¼š
```python
# ä½¿ç”¨ä»»æ„TTSç”Ÿæˆä¸€æ®µå‚è€ƒéŸ³é¢‘
# è¿™æ ·å¯ä»¥å…ˆè·‘é€šæµç¨‹ï¼Œåç»­å†æ›¿æ¢æˆçœŸæ­£çš„"å°O"éŸ³è‰²
```

---

## ğŸš€ è¿è¡Œç”Ÿæˆ

### åŸºç¡€ç”¨æ³•

```bash
# é»˜è®¤ä½¿ç”¨ instruct2 æ¨¡å¼
python tts_batch_generator.py

# æˆ–è€…æŒ‡å®šå‚æ•°
python tts_batch_generator.py \
  --script training_complete.json \
  --output digital_human_training_data \
  --prompt ./reference_audio/prompt.wav \
  --mode instruct2
```

### å‚æ•°è¯´æ˜

| å‚æ•° | é»˜è®¤å€¼ | è¯´æ˜ |
|------|--------|------|
| `--script` | training_script.json | è®­ç»ƒæ–‡æ¡ˆJSONæ–‡ä»¶ |
| `--output` | digital_human_training_data | è¾“å‡ºç›®å½• |
| `--model` | pretrained_models/Fun-CosyVoice3-0.5B | æ¨¡å‹è·¯å¾„ï¼ˆè‡ªåŠ¨ä¸‹è½½ï¼‰ |
| `--prompt` | ./reference_audio/prompt.wav | å‚è€ƒéŸ³é¢‘è·¯å¾„ |
| `--mode` | instruct2 | ç”Ÿæˆæ¨¡å¼ (instruct2/zero_shot) |

### æŸ¥çœ‹å‚è€ƒéŸ³é¢‘å‡†å¤‡è¯´æ˜

```bash
python tts_batch_generator.py --prepare-ref
```

---

## ğŸ“Š è¿è¡Œç¤ºä¾‹

### å®Œæ•´æµç¨‹æ¼”ç¤º

```bash
# 1. å‡†å¤‡å‚è€ƒéŸ³é¢‘
# (å½•åˆ¶"å°O"çš„éŸ³é¢‘ï¼Œä¿å­˜ä¸º ./reference_audio/prompt.wav)

# 2. è¿è¡Œç”Ÿæˆï¼ˆç¬¬ä¸€æ¬¡ä¼šè‡ªåŠ¨ä¸‹è½½æ¨¡å‹ï¼‰
python tts_batch_generator.py --script training_complete.json

# è¾“å‡ºç¤ºä¾‹ï¼š
# æ­£åœ¨åŠ è½½ CosyVoice3 æ¨¡å‹...
# å¦‚æœæ˜¯é¦–æ¬¡è¿è¡Œï¼Œå°†è‡ªåŠ¨ä» ModelScope ä¸‹è½½æ¨¡å‹ï¼ˆçº¦500MBï¼‰
# âœ… æ¨¡å‹åŠ è½½æˆåŠŸï¼é‡‡æ ·ç‡: 22050Hz
# âœ… ä½¿ç”¨æ¨¡å¼: instruct2
#
# å¼€å§‹ç”ŸæˆéŸ³é¢‘...
# æ€»sectionæ•°: 64
#
# [1/64] ç”Ÿæˆ [åŸºç¡€éŸ³ç´ -å•å…ƒéŸ³-å¼ å˜´a]
#   0001. å¤§å®¶å¥½å•Šï¼ŒèŠ±èŠ±ï¼Œçˆ¸çˆ¸å¦ˆå¦ˆï¼Œå“ˆå“ˆå¤§ç¬‘ã€‚
# [2/64] ç”Ÿæˆ [åŸºç¡€éŸ³ç´ -å•å…ƒéŸ³-æ‰å˜´i]
#   0002. ä¸€ä¸ƒè¥¿ç“œï¼Œæœºå™¨é¸¡é¸¡ï¼Œcheeseä¸€èµ·ã€‚
# ...
#
# âœ… å®Œæˆï¼
# ç”ŸæˆéŸ³é¢‘æ•°: 145
# æ€»æ—¶é•¿: 65.3 åˆ†é’Ÿ
# è¾“å‡ºç›®å½•: digital_human_training_data
```

### è¾“å‡ºç›®å½•ç»“æ„

```
digital_human_training_data/
â”œâ”€â”€ audio/
â”‚   â”œâ”€â”€ audio_0001.wav  # å¤§å®¶å¥½å•Š...
â”‚   â”œâ”€â”€ audio_0002.wav  # ä¸€ä¸ƒè¥¿ç“œ...
â”‚   â”œâ”€â”€ audio_0003.wav
â”‚   â””â”€â”€ ... (145ä¸ªæ–‡ä»¶)
â””â”€â”€ metadata/
    â””â”€â”€ index.json      # å®Œæ•´çš„å…ƒæ•°æ®ç´¢å¼•
```

### å…ƒæ•°æ®æ ¼å¼

```json
[
  {
    "id": 1,
    "filename": "audio_0001.wav",
    "text": "å¤§å®¶å¥½å•Šï¼ŒèŠ±èŠ±ï¼Œçˆ¸çˆ¸å¦ˆå¦ˆï¼Œå“ˆå“ˆå¤§ç¬‘ã€‚",
    "section": "åŸºç¡€éŸ³ç´ -å•å…ƒéŸ³-å¼ å˜´a",
    "emotion": "neutral",
    "duration": 4.2,
    "sample_rate": 22050
  },
  {
    "id": 2,
    "filename": "audio_0002.wav",
    "text": "å“‡ï¼çœŸçš„å—ï¼Ÿå¤ªæ£’äº†ï¼",
    "section": "æƒ…ç»ªæ¼”ç»-å¼€å¿ƒæ¿€åŠ¨",
    "emotion": "happy",
    "duration": 2.8,
    "sample_rate": 22050
  }
]
```

---

## ğŸ”§ é«˜çº§é…ç½®

### 1. è°ƒæ•´æƒ…ç»ªå¼ºåº¦

ç¼–è¾‘è„šæœ¬ä¸­çš„ `emotion_to_instruct` å­—å…¸ï¼š

```python
self.emotion_to_instruct = {
    'happy': 'è¯·ç”¨éå¸¸å¼€å¿ƒã€æåº¦å…´å¥‹ã€ç‹‚å–œçš„è¯­æ°”è¯´è¯ã€‚',  # åŠ å¼ºæƒ…ç»ª
    'sad': 'è¯·ç”¨æ‚²ä¼¤ã€ä½è½çš„è¯­æ°”è¯´è¯ã€‚',  # ä¿æŒåŸæ ·
}
```

### 2. æ§åˆ¶è¯­é€Ÿ

ä¸ºç‰¹å®šsectionæ·»åŠ è¯­é€Ÿæ§åˆ¶ï¼š

```python
# åœ¨generate_audioä¸­æ·»åŠ è¯­é€Ÿåˆ¤æ–­
if 'å¿«é€Ÿè¿è¯»' in section['section']:
    instruct += ' è¯·ç”¨å°½å¯èƒ½å¿«çš„è¯­é€Ÿè¯´è¯ã€‚'
elif 'åœé¡¿å‘¼å¸' in section['section']:
    instruct += ' è¯·ç”¨ç¼“æ…¢çš„è¯­é€Ÿï¼Œé€‚å½“åœé¡¿ã€‚'
```

### 3. æ‰¹é‡å¤„ç†å¤šä¸ªæ–‡æ¡ˆ

```bash
# ç”ŸæˆåŸºç¡€æ–‡æ¡ˆ
python tts_batch_generator.py \
  --script training_data.json \
  --output training_data_output

# ç”Ÿæˆæ‰©å±•æ–‡æ¡ˆ
python tts_batch_generator.py \
  --script training_extend_data.json \
  --output training_extend_output
```

### 4. ä½¿ç”¨ä¸åŒçš„å‚è€ƒéŸ³é¢‘

```bash
# ä½¿ç”¨"å°O"å¼€å¿ƒæ—¶çš„éŸ³è‰²
python tts_batch_generator.py \
  --prompt ./reference_audio/xiao_o_happy.wav

# ä½¿ç”¨"å°O"å¹³é™æ—¶çš„éŸ³è‰²
python tts_batch_generator.py \
  --prompt ./reference_audio/xiao_o_calm.wav
```

---

## âš ï¸ å¸¸è§é—®é¢˜

### Q1: æ¨¡å‹ä¸‹è½½å¤±è´¥ï¼Ÿ

**A:** æ‰‹åŠ¨ä¸‹è½½æ¨¡å‹
```bash
# è®¿é—® ModelScope
https://www.modelscope.cn/models/FunAudioLLM/CosyVoice3-0.5B

# ä¸‹è½½åˆ°æœ¬åœ°åï¼ŒæŒ‡å®šè·¯å¾„
python tts_batch_generator.py --model /path/to/downloaded/model
```

### Q2: ç”Ÿæˆçš„éŸ³é¢‘æƒ…ç»ªä¸æ˜æ˜¾ï¼Ÿ

**A:** åŠ å¼ºæŒ‡ä»¤è¡¨è¾¾
```python
# ä¿®æ”¹emotion_to_instructï¼Œä½¿ç”¨æ›´å¼ºçƒˆçš„æè¿°
'happy': 'è¯·ç”¨æåº¦å¼€å¿ƒã€å…´é«˜é‡‡çƒˆã€æ¬¢å‘¼é›€è·ƒçš„è¯­æ°”å¤§å£°è¯´è¯ï¼'
```

### Q3: å‚è€ƒéŸ³é¢‘è´¨é‡è¦æ±‚ï¼Ÿ

**A:** æœ€ä½è¦æ±‚
- é‡‡æ ·ç‡ï¼šâ‰¥16kHz
- æ—¶é•¿ï¼š10-30ç§’
- å™ªéŸ³ï¼šå°½é‡å°
- å†…å®¹ï¼šåŒ…å«å¤šç§éŸ³ç´ 

### Q4: ç”Ÿæˆé€Ÿåº¦æ…¢ï¼Ÿ

**A:** ä¼˜åŒ–æ–¹æ¡ˆ
```python
# 1. ä½¿ç”¨GPUåŠ é€Ÿï¼ˆè‡ªåŠ¨æ£€æµ‹ï¼‰
# 2. å‡å°‘æ–‡æ¡ˆæ•°é‡ï¼ˆå…ˆç”¨å°æ•°æ®é›†éªŒè¯ï¼‰
# 3. åˆ†æ‰¹å¤„ç†

# åªç”Ÿæˆå‰10å¥æµ‹è¯•
script_sections = script_sections[:2]  # åªå–å‰2ä¸ªsection
```

### Q5: å¦‚ä½•éªŒè¯ç”Ÿæˆè´¨é‡ï¼Ÿ

**A:** æ£€æŸ¥æ¸…å•
```python
import torchaudio
import json

# åŠ è½½å…ƒæ•°æ®
with open('metadata/index.json', 'r') as f:
    metadata = json.load(f)

# æ£€æŸ¥æ¯ä¸ªéŸ³é¢‘
for meta in metadata[:10]:  # æ£€æŸ¥å‰10ä¸ª
    audio, sr = torchaudio.load(f"audio/{meta['filename']}")
    
    # æ£€æŸ¥æ—¶é•¿
    duration = audio.shape[1] / sr
    print(f"{meta['filename']}: {duration:.2f}s, é¢„æœŸ:{meta['duration']:.2f}s")
    
    # æ£€æŸ¥éŸ³é‡
    volume = audio.abs().mean().item()
    print(f"  éŸ³é‡: {volume:.4f}")
```

---

## ğŸ¯ å®Œæ•´å·¥ä½œæµç¨‹

### Step 1: å‡†å¤‡é˜¶æ®µï¼ˆ30åˆ†é’Ÿï¼‰
```bash
# 1. å®‰è£…ä¾èµ–
pip install modelscope torchaudio

# 2. å‡†å¤‡å‚è€ƒéŸ³é¢‘
# å½•åˆ¶"å°O"çš„éŸ³é¢‘ â†’ ./reference_audio/prompt.wav

# 3. å‡†å¤‡æ–‡æ¡ˆ
# åˆå¹¶ training_data.json + training_extend_data.json
```

### Step 2: ç”ŸæˆéŸ³é¢‘ï¼ˆ1-2å°æ—¶ï¼‰
```bash
# è¿è¡Œç”Ÿæˆï¼ˆè‡ªåŠ¨ä¸‹è½½æ¨¡å‹+ç”ŸæˆéŸ³é¢‘ï¼‰
python tts_batch_generator.py --script training_complete.json

# å–æ¯å’–å•¡ï¼Œç­‰å¾…å®Œæˆ â˜•
```

### Step 3: è´¨é‡æ£€æŸ¥ï¼ˆ15åˆ†é’Ÿï¼‰
```bash
# 1. æ£€æŸ¥ç”Ÿæˆæ•°é‡
ls digital_human_training_data/audio/*.wav | wc -l

# 2. éšæœºå¬å‡ ä¸ªéŸ³é¢‘ï¼Œæ£€æŸ¥ï¼š
#    - éŸ³è‰²æ˜¯å¦ç»Ÿä¸€
#    - æƒ…ç»ªæ˜¯å¦æ˜æ˜¾
#    - å‘éŸ³æ˜¯å¦æ¸…æ™°

# 3. å¦‚æœæœ‰é—®é¢˜ï¼Œè°ƒæ•´å‚æ•°é‡æ–°ç”Ÿæˆ
```

### Step 4: éŸ³ç´ è¦†ç›–åº¦éªŒè¯ï¼ˆ5åˆ†é’Ÿï¼‰
```bash
# ç¡®è®¤éŸ³ç´ è¦†ç›–åº¦
python phoneme_coverage_analysis.py training_complete.json
# åº”è¯¥æ˜¾ç¤º: ã€æ€»ä½“è¯„çº§ã€‘: ä¼˜ç§€ (Excellent)
```

---

## ğŸ’¡ æœ€ä½³å®è·µ

1. **å‚è€ƒéŸ³é¢‘è´¨é‡ç¬¬ä¸€**
   - å®å¯å¤šèŠ±æ—¶é—´å½•åˆ¶é«˜è´¨é‡å‚è€ƒéŸ³é¢‘
   - è¿™å†³å®šäº†æ‰€æœ‰ç”ŸæˆéŸ³é¢‘çš„åŸºç¡€éŸ³è‰²

2. **å…ˆå°è§„æ¨¡æµ‹è¯•**
   - ç”¨å‰10å¥æµ‹è¯•æµç¨‹
   - ç¡®è®¤éŸ³è‰²ã€æƒ…ç»ªæ»¡æ„åå†æ‰¹é‡ç”Ÿæˆ

3. **ä¿ç•™åŸå§‹éŸ³é¢‘**
   - ä¸è¦å¯¹ç”Ÿæˆçš„éŸ³é¢‘åšäºŒæ¬¡å¤„ç†
   - åç»­è®­ç»ƒæ—¶å¯èƒ½éœ€è¦é‡æ–°å¤„ç†

4. **å¤‡ä»½å…ƒæ•°æ®**
   - index.json å¾ˆé‡è¦
   - è®°å½•äº†éŸ³é¢‘å’Œæ–‡æœ¬çš„å¯¹åº”å…³ç³»

---

## ğŸ“š ä¸‹ä¸€æ­¥

ç”ŸæˆéŸ³é¢‘åï¼Œä½ éœ€è¦ï¼š

1. **ç”Ÿæˆå¯¹åº”è§†é¢‘**
   - ä½¿ç”¨çœŸäººè§†é¢‘å½•åˆ¶
   - æˆ–ä½¿ç”¨JoyVASA/LivePortraitç”Ÿæˆ

2. **æå–è¿åŠ¨å‚æ•°**
   - ç”¨LivePortraitæå–motionå‚æ•°
   - å»ºç«‹ {éŸ³é¢‘ â†’ è¿åŠ¨å‚æ•°} çš„è®­ç»ƒå¯¹

3. **è®­ç»ƒAudio2Motionæ¨¡å‹**
   - ä½¿ç”¨è½»é‡çº§ç½‘ç»œ
   - é’ˆå¯¹ç§»åŠ¨ç«¯ä¼˜åŒ–

è¯¦è§åç»­æ•™ç¨‹ï¼šã€ŠAudio2Motionæ¨¡å‹è®­ç»ƒæŒ‡å—ã€‹
